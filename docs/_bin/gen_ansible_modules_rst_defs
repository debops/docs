#!/bin/bash
## @author Copyright (C) 2016 Robin Schneider <ypid@riseup.net>
## @author Copyright (C) 2021 CipherMail B.V. <https://www.ciphermail.com/>
## @license GPL-3.0 <https://www.gnu.org/licenses/gpl-3.0.html>

## Generate URL definitions of all Ansible modules in RST.

set -e

# Prints ReStructredText hyperlink targets
print_module_target() {
    if [[ "$1" == *\.* ]]; then
        # This is a collection module (ansible-doc name contains periods)
        echo ".. _Ansible $1 module: https://docs.ansible.com/ansible/latest/collections/${1//\./\/}_module.html"
    else
        # This is an ansible.builtin module (ansible-doc name does not contain periods)
        echo ".. _Ansible ansible.builtin.$1 module: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/$1_module.html"
    fi
}

echo '.. Ansible modules [[[
.. This section was generated by: https://github.com/debops/docs/blob/master/docs/_bin/gen_ansible_modules_rst_defs
'

## dev/testing: `ansible-doc -l` needs to be cached because it is that freaking slow.
# test -f "/tmp/ansible_module.list" || ansible-doc -l 2>/dev/null > "/tmp/ansible_module.list"
# cut -d ' ' -f 1 "/tmp/ansible_module.list" | while read -r ansible_module_name

ansible-doc -l 2>/dev/null | grep -v deprecated | cut -d ' ' -f 1 | while read -r ansible_module_name
do
    print_module_target "$ansible_module_name"
done

echo ".. Deprecated modules follow:"

ansible-doc -l 2>/dev/null | grep deprecated | cut -d ' ' -f 1 | while read -r ansible_module_name
do
    print_module_target "$ansible_module_name"
done

echo '.. ]]]'
